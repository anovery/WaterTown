## 阶段目标

实现场景编辑器，包括水面渲染、场景编辑、船只物理系统。

---

## 使用指南

### 启动程序

```bash
cd H:\WaterTown-main\WaterTown-main\build
.\WaterTown.exe
```

### 操作说明

#### 地形编辑模式

1. 点击 "地形编辑" 按钮
2. 右键拖拽平移视图
3. 滚轮缩放
4. 在工具面板选择地形类型（草地/水路/石路）
5. 左键点击网格放置地形

#### 建筑布置模式

1. 点击 "建筑布置" 按钮
2. 右键拖拽旋转视角
3. 滚轮调整距离
4. 在工具面板选择物体类型（房子/桥/树/船）
5. 左键点击网格放置建筑物

#### 游戏模式

1. 点击 "游戏模式" 按钮
2. 使用 **WASD** 控制船只：
   - **W** - 前进加速
   - **S** - 后退减速
   - **A** - 左转
   - **D** - 右转
3. 观察船只随水波起伏
4. 划船物理

---

## 新增文件

### 1. 水面渲染系统

- `src/Water/WaterSurface.h` - 水面类头文件
- `src/Water/WaterSurface.cpp` - 水面类实现
- `assets/shaders/water.vert` - 水面顶点着色器（Gerstner Waves）
- `assets/shaders/water.frag` - 水面片段着色器（Fresnel效果）

### 2. 场景编辑器系统

- `src/Editor/SceneEditor.h` - 场景编辑器核心
- `src/Editor/SceneEditor.cpp` - 场景编辑器实现
- `src/Editor/EditorUI.h` - ImGui界面管理
- `src/Editor/EditorUI.cpp` - UI面板实现
- `src/Render/OrthographicCamera.h` - 正交相机（地形编辑）
- `src/Render/OrthographicCamera.cpp` - 正交相机实现
- `src/Render/OrbitCamera.h` - 轨道相机（建筑布置）
- `src/Render/OrbitCamera.cpp` - 轨道相机实现
- `src/Render/FollowCamera.h` - 追随相机（船只跟随）
- `src/Render/FollowCamera.cpp` - 追随相机实现

### 3. 船只物理系统

- `src/Physics/Boat.h` - 船只物理模拟
- `src/Physics/Boat.cpp` - 船只物理实现
- `src/Render/BoatRenderer.h` - 船只渲染器
- `src/Render/BoatRenderer.cpp` - 船只几何模型

---

## 修改文件

- `src/main.cpp` - 集成所有新系统，添加游戏模式控制
- `src/Core/Window.cpp` - 添加 `#include <stdexcept>`
- `src/Render/Shader.h` - 新增 `setVec2()` 方法
- `src/Render/Shader.cpp` - 实现 `setVec2()` 方法
- `CMakeLists.txt` - C++标准从17降级到14（兼容旧编译器）

---

## 功能实现详情

### 2.1 水面渲染系统

- **网格规模**: 100x100 网格，10201个顶点，20000个三角形
- **波浪算法**: Gerstner Waves（4个波浪参数叠加）
- **视觉效果**:
  - Fresnel反射/折射
  - 深度感知的颜色变化
  - 波峰泡沫效果
  - 实时法线计算

#### 技术参数

```cpp
// 波浪参数
Wave waves[4] = {
    {amplitude: 0.15, wavelength: 5.0, speed: 2.0, direction: (1,0)},
    {amplitude: 0.10, wavelength: 3.0, speed: 1.5, direction: (1,0.6)},
    {amplitude: 0.08, wavelength: 2.0, speed: 1.0, direction: (0.7,0.7)},
    {amplitude: 0.05, wavelength: 1.5, speed: 0.8, direction: (-0.5,1)}
};
```

#### 接口

```cpp
float WaterSurface::getWaterHeight(float worldX, float worldZ, float time)
```

- 提供给船只浮力系统使用
- 支持任意世界坐标的水面高度查询

---

### 2.2 场景编辑器

#### 三种编辑模式

##### 1. 地形编辑模式 (TERRAIN)

- **相机**: OrthographicCamera（正交视角，俯视图）
- **操作**:
  - 鼠标右键拖拽：平移视图
  - 滚轮：缩放
- **功能**:
  - 50x50 地形网格
  - 三种地形类型：草地、水路、石路
  - 左键点击放置地形（✅ 已实现）

##### 2. 建筑布置模式 (BUILDING)

- **相机**: OrbitCamera（轨道相机，环绕目标）
- **操作**:
  - 鼠标右键拖拽：旋转视角
  - 滚轮：调整距离
- **功能**:
  - 物体类型：房子、桥、树、船
  - 3D预览和放置（✅ 已实现）

##### 3. 游戏模式 (GAME)

- **相机**: FollowCamera（追随相机，跟随船只）
- **操作**:
  - WASD：控制船只
  - 相机自动跟随
- **功能**:
  - 真实划船体验
  - 实时物理模拟

#### EditorUI 界面组成

##### 面板1: 模式选择面板 (Mode Panel)

- 三个按钮切换编辑模式
- 彩色文本指示当前模式

##### 面板2: 工具面板 (Tool Panel)

- 地形模式：地形类型选择（草地/水路/石路）
- 建筑模式：物体类型选择（房子/桥/树/船）

##### 面板3: 设置面板 (Settings Panel)

- 显示选项：网格、水面、建筑物
- 网格大小滑块

##### 面板4: 统计面板 (Stats Panel)

- FPS显示
- 地形统计：草地/水路/石路数量

##### 面板5: 场景管理面板 (Scene Panel)

- 保存场景（UI 已实现，功能待完善）
- 加载场景（UI 已实现，功能待完善）
- 清空场景（UI 已实现，功能待完善）

---

### 三、船只物理系统 (2.3)

#### 1. 动力学系统

```cpp
// 物理常数
MAX_SPEED = 5.0 m/s          // 最大速度
ACCELERATION = 2.0 m/s²      // 加速度
DECELERATION = 1.0 m/s²      // 减速度
TURN_SPEED = 60.0°/s         // 转向速度
DRAG = 0.5                   // 水阻力系数
```

**运动特性**:

- 非瞬时加速，有加速度过程
- 转向速度与前进速度成正比
- 松开按键后指数衰减减速：`speed *= exp(-DRAG * deltaTime)`
- 前进时轻微左右摇晃：`roll = sin(time * 2.0) * 0.01 * speedFactor`

#### 2. 浮力系统

**4点采样策略**:

```
      船头 (Bow)
        ↑
左舷 ← 中心 → 右舷 (Port/Starboard)
        ↓
      船尾 (Stern)
```

**姿态计算**:

```cpp
// 俯仰角 (Pitch)
pitch = atan2(heightBow - heightStern, BOAT_LENGTH) * 180/π * 0.3

// 翻滚角 (Roll)
waterRoll = atan2(heightStarboard - heightPort, BOAT_WIDTH) * 180/π
roll = motionRoll * 0.5 + waterRoll * 0.5  // 混合运动和水波
```

#### 3. 碰撞检测

**边界检测**:

- 检测船只是否超出水域范围（默认 -20 到 20 范围）
- 超出时推回边界内
- 碰撞时速度衰减至30%

**障碍物碰撞**:

- 圆形碰撞体（简化版）
- 自动将所有放置的建筑物添加为障碍物
  - 房子：碰撞半径 1.5m
  - 桥：碰撞半径 1.0m
  - 树：碰撞半径 0.5m
  - 其他船只：碰撞半径 0.8m
- 推开效果：`position += pushDir * pushAmount`
- 切换到游戏模式时自动更新障碍物列表

#### 4. 追随相机

**跟随算法**:

```cpp
// 指数平滑插值
float t = 1.0 - exp(-smoothSpeed * deltaTime);
position = mix(currentPos, desiredPos, t);
```

**特性**:

- 默认偏移：后方5米，上方2.5米
- 平滑速度：5.0（可配置）
- 自动旋转跟随船只朝向

#### 5. 船只渲染

**几何模型**:

- 船体：2.0m × 0.4m × 0.8m 长方体
- 船帆：简单三角形（装饰）
- 木色材质：RGB(0.6, 0.4, 0.2)

**渲染管线**:

```cpp
model = translate(position)
      * rotate(yaw)      // Y轴旋转
      * rotate(pitch)    // X轴俯仰
      * rotate(roll)     // Z轴翻滚
```

---

## 文件结构

```
WaterTown-main/
├── src/
│   ├── Core/           (修改 Application.cpp, Window.cpp)
│   ├── Render/         (新增 10个文件：相机系统+渲染器, 修改 Shader.h/.cpp)
│   ├── Water/          (新增 WaterSurface.h/.cpp)
│   ├── Editor/         (新增 SceneEditor.h/.cpp, EditorUI.h/.cpp, TerrainRenderer.h)
│   ├── Physics/        (新增 Boat.h/.cpp)
│   └── main.cpp        (大幅修改，集成所有系统)
├── assets/
│   └── shaders/        (新增 water.vert/frag, 保留 basic.vert/frag)
└── CMakeLists.txt      (C++ 标准改为 14)
```

---

## 总结

### 1. Gerstner Waves 水面模拟

采用Gerstner波浪算法，通过多个波浪叠加产生复杂自然的水面运动。

### 2. 多相机架构设计

通过Camera基类定义统一接口，三种相机各司其职：
与碰撞检测

- 加速度和惯性系统
- 水阻力（指数衰减）
- 4点浮力采样（船头、船尾、左舷、右舷）
- 动态姿态计算（俯仰角和翻滚角）
- 完整的碰撞检测系统（边界+建筑物障碍物）理模拟
- 加速度和惯性
- 水阻力（指数衰减）
- 4点浮力采样
- 动态姿态计算

### 4. 指数平滑算法

相机跟随使用 `1.0 - exp(-speed * dt)` 实现平滑插值，效果比线性插值自然，且帧率无关。

---

## 参考资料

### Gerstner Waves

- GPU Gems Chapter 1: Effective Water Simulation from Physical Models

### 相机系统

- Unity/Unreal Engine相机设计文档

### 物理模拟

- Game Physics Engine Development (Ian Millington)
- Real-Time Rendering, 4th Edition
